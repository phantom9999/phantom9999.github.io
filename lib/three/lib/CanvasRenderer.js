THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var d,h,m,x,y,R,v,u,T,g,S,H,w,C,M,b,L,B,P,V=this,W=new THREE.Projector,o=void 0!==e.canvas?e.canvas:document.createElement("canvas"),z=o.width,j=o.height,k=Math.floor(z/2),D=Math.floor(j/2),F=0,N=0,O=z,A=j,n=1,I=o.getContext("2d",{alpha:!0===e.alpha}),i=new THREE.Color(0),r=!0===e.alpha?0:1,a=1,s=0,l=null,c=null,p=null,E=null,f=null,t=[],G=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),U=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),q=new THREE.Color,J=new THREE.Color,K={},Q=new THREE.Box2,X=new THREE.Box2,Y=new THREE.Box2,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee=new THREE.Vector3,te=new THREE.Vector3,ie=new THREE.Vector3,oe=new THREE.Matrix3;function ne(e,t,i,o){Ee(t),fe(i),de(o),he(e.getStyle()),I.stroke(),Y.expandByScalar(2*t)}function re(e){me(e.getStyle()),I.fill()}function ae(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,o=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,n=e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(n?2:1),a.height=t.height*(r?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0==n&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0==r&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0==n&&!0==r&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));t="no-repeat";!0==i&&!0==o?t="repeat":!0==i?t="repeat-x":!0==o&&(t="repeat-y");t=I.createPattern(a,t);return e.onUpdate&&e.onUpdate(e),{canvas:t,version:e.version}}function se(e,t,i,o,n,r,a,s,l,c,p,E,f){var d=K[f.id];if(void 0!==d&&d.version===f.version||(d=ae(f),K[f.id]=d),void 0===d.canvas)return me("rgba( 0, 0, 0, 1)"),void I.fill();me(d.canvas);var h=f.offset.x/f.repeat.x,m=f.offset.y/f.repeat.y,d=f.image.width*f.repeat.x,f=f.image.height*f.repeat.y;l=(l+h)*d,c=(c+m)*f,p=(p+h)*d,E=(E+m)*f,i-=e,o-=t,n-=e,r-=t,0!=(f=(l-=a=(a+h)*d)*(E-=s=(s+m)*f)-(p-=a)*(c-=s))&&(i=e-(f=(E*i-c*n)*(e=1/f))*a-(n=(l*n-p*i)*e)*s,s=t-(c=(E*o-c*r)*e)*a-(e=(l*r-p*o)*e)*s,I.save(),I.transform(f,c,n,e,i,s),I.fill(),I.restore())}function le(e,t,i){var o=t.x-e.x,n=t.y-e.y,r=o*o+n*n;0!=r&&(n*=r=i/Math.sqrt(r),t.x+=o*=r,t.y+=n,e.x-=o,e.y-=n)}function ce(e){a!==e&&(I.globalAlpha=e,a=e)}function pe(e){s!==e&&(e===THREE.NormalBlending?I.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?I.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?I.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(I.globalCompositeOperation="multiply"),s=e)}function Ee(e){p!==e&&(I.lineWidth=e,p=e)}function fe(e){E!==e&&(I.lineCap=e,E=e)}function de(e){f!==e&&(I.lineJoin=e,f=e)}function he(e){l!==e&&(I.strokeStyle=e,l=e)}function me(e){c!==e&&(I.fillStyle=e,c=e)}function xe(e){t.length!==e.length&&(I.setLineDash(e),t=e)}void 0===I.setLineDash&&(I.setLineDash=function(){}),this.domElement=o,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return I},this.getContextAttributes=function(){return I.getContextAttributes()},this.getPixelRatio=function(){return n},this.setPixelRatio=function(e){void 0!==e&&(n=e)},this.setSize=function(e,t,i){z=e*n,j=t*n,o.width=z,o.height=j,k=Math.floor(z/2),D=Math.floor(j/2),!1!==i&&(o.style.width=e+"px",o.style.height=t+"px"),Q.min.set(-k,-D),Q.max.set(k,D),X.min.set(-k,-D),X.max.set(k,D),a=1,s=0,f=E=p=c=l=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,o){F=e*n,N=t*n,O=i*n,A=o*n},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1,X.min.set(-k,-D),X.max.set(k,D)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return i},this.getClearAlpha=function(){return r},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===X.isEmpty()&&(X.intersect(Q),X.expandByScalar(2),X.min.x=X.min.x+k,X.min.y=-X.min.y+D,X.max.x=X.max.x+k,X.max.y=-X.max.y+D,r<1&&I.clearRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0),0<r&&(pe(THREE.NormalBlending),ce(1),me("rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"),I.fillRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0)),X.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof THREE.Camera!=!1){var i=e.background;i&&i.isColor?(me("rgb("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+")"),I.fillRect(0,0,z,j)):!0===this.autoClear&&this.clear(),V.info.render.vertices=0,V.info.render.faces=0,I.setTransform(O/z,0,0,-A/j,F,j-N),I.translate(k,D),d=W.projectScene(e,t,this.sortObjects,this.sortElements),h=d.elements,m=d.lights,oe.getNormalMatrix(t.matrixWorldInverse),function(){Z.setRGB(0,0,0),$.setRGB(0,0,0),_.setRGB(0,0,0);for(var e=0,t=m.length;e<t;e++){var i=m[e],o=i.color;i instanceof THREE.AmbientLight?Z.add(o):i instanceof THREE.DirectionalLight?$.add(o):i instanceof THREE.PointLight&&_.add(o)}}();for(var o,n,r,a,s,l,c=0,p=h.length;c<p;c++){var E=h[c],f=E.material;if(void 0!==f&&0!==f.opacity){if(Y.makeEmpty(),E instanceof THREE.RenderableSprite)(x=E).x*=k,x.y*=D,function(e,t,i){ce(i.opacity),pe(i.blending);var o=t.scale.x*k,n=t.scale.y*D,r=.5*Math.sqrt(o*o+n*n);{var a,s,l,c;Y.min.set(e.x-r,e.y-r),Y.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial?null!==(c=i.map)?(void 0!==(s=K[c.id])&&s.version===c.version||(s=ae(c),K[c.id]=s),void 0!==s.canvas&&(me(s.canvas),l=c.image,a=l.width*c.offset.x,t=l.height*c.offset.y,r=l.width*c.repeat.x,s=l.height*c.repeat.y,l=o/r,c=n/s,I.save(),I.translate(e.x,e.y),0!==i.rotation&&I.rotate(i.rotation),I.translate(-o/2,-n/2),I.scale(l,c),I.translate(-a,-t),I.fillRect(a,t,r,s),I.restore())):(me(i.color.getStyle()),I.save(),I.translate(e.x,e.y),0!==i.rotation&&I.rotate(i.rotation),I.scale(o,-n),I.fillRect(-.5,-.5,1,1),I.restore()):i instanceof THREE.SpriteCanvasMaterial&&(he(i.color.getStyle()),me(i.color.getStyle()),I.save(),I.translate(e.x,e.y),0!==i.rotation&&I.rotate(i.rotation),I.scale(o,n),i.program(I),I.restore())}}(x,E,f);else if(E instanceof THREE.RenderableLine)x=E.v1,y=E.v2,x.positionScreen.x*=k,x.positionScreen.y*=D,y.positionScreen.x*=k,y.positionScreen.y*=D,Y.setFromPoints([x.positionScreen,y.positionScreen]),!0===Q.intersectsBox(Y)&&function(e,t,i,o){if(ce(o.opacity),pe(o.blending),I.beginPath(),I.moveTo(e.positionScreen.x,e.positionScreen.y),I.lineTo(t.positionScreen.x,t.positionScreen.y),o instanceof THREE.LineBasicMaterial){if(Ee(o.linewidth),fe(o.linecap),de(o.linejoin),o.vertexColors!==THREE.VertexColors)he(o.color.getStyle());else{var n=i.vertexColors[0].getStyle(),i=i.vertexColors[1].getStyle();if(n===i)he(n);else{try{var r=I.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);r.addColorStop(0,n),r.addColorStop(1,i)}catch(e){r=n}he(r)}}I.stroke(),Y.expandByScalar(2*o.linewidth)}else o instanceof THREE.LineDashedMaterial&&(Ee(o.linewidth),fe(o.linecap),de(o.linejoin),he(o.color.getStyle()),xe([o.dashSize,o.gapSize]),I.stroke(),Y.expandByScalar(2*o.linewidth),xe([]))}(x,y,E,f);else if(E instanceof THREE.RenderableFace){if(x=E.v1,y=E.v2,R=E.v3,x.positionScreen.z<-1||1<x.positionScreen.z)continue;if(y.positionScreen.z<-1||1<y.positionScreen.z)continue;if(R.positionScreen.z<-1||1<R.positionScreen.z)continue;x.positionScreen.x*=k,x.positionScreen.y*=D,y.positionScreen.x*=k,y.positionScreen.y*=D,R.positionScreen.x*=k,R.positionScreen.y*=D,0<f.overdraw&&(le(x.positionScreen,y.positionScreen,f.overdraw),le(y.positionScreen,R.positionScreen,f.overdraw),le(R.positionScreen,x.positionScreen,f.overdraw)),Y.setFromPoints([x.positionScreen,y.positionScreen,R.positionScreen]),!0===Q.intersectsBox(Y)&&(o=x,n=y,r=R,a=0,s=1,l=2,E=E,f=f,V.info.render.vertices+=3,V.info.render.faces++,ce(f.opacity),pe(f.blending),v=o.positionScreen.x,u=o.positionScreen.y,T=n.positionScreen.x,g=n.positionScreen.y,S=r.positionScreen.x,H=r.positionScreen.y,function(e,t,i,o,n,r){I.beginPath(),I.moveTo(e,t),I.lineTo(i,o),I.lineTo(n,r),I.closePath()}(v,u,T,g,S,H),(f instanceof THREE.MeshLambertMaterial||f instanceof THREE.MeshPhongMaterial)&&null===f.map?(U.copy(f.color),q.copy(f.emissive),f.vertexColors===THREE.FaceColors&&U.multiply(E.color),G.copy(Z),te.copy(o.positionWorld).add(n.positionWorld).add(r.positionWorld).divideScalar(3),function(e,t,i){for(var o=0,n=m.length;o<n;o++){var r,a,s=m[o];J.copy(s.color),s instanceof THREE.DirectionalLight?(r=ee.setFromMatrixPosition(s.matrixWorld).normalize(),(a=t.dot(r))<=0||(a*=s.intensity,i.add(J.multiplyScalar(a)))):s instanceof THREE.PointLight&&(r=ee.setFromMatrixPosition(s.matrixWorld),(a=t.dot(ee.subVectors(r,e).normalize()))<=0||0!=(a*=0==s.distance?1:1-Math.min(e.distanceTo(r)/s.distance,1))&&(a*=s.intensity,i.add(J.multiplyScalar(a))))}}(te,E.normalModel,G),G.multiply(U).add(q),!0===f.wireframe?ne(G,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):re(G)):f instanceof THREE.MeshBasicMaterial||f instanceof THREE.MeshLambertMaterial||f instanceof THREE.MeshPhongMaterial?null!==f.map?f.map.mapping===THREE.UVMapping&&(w=E.uvs,se(v,u,T,g,S,H,w[a].x,w[a].y,w[s].x,w[s].y,w[l].x,w[l].y,f.map)):null!==f.envMap?f.envMap.mapping===THREE.SphericalReflectionMapping&&(ie.copy(E.vertexNormalsModel[a]).applyMatrix3(oe),C=.5*ie.x+.5,M=.5*ie.y+.5,ie.copy(E.vertexNormalsModel[s]).applyMatrix3(oe),b=.5*ie.x+.5,L=.5*ie.y+.5,ie.copy(E.vertexNormalsModel[l]).applyMatrix3(oe),B=.5*ie.x+.5,P=.5*ie.y+.5,se(v,u,T,g,S,H,C,M,b,L,B,P,f.envMap)):(G.copy(f.color),f.vertexColors===THREE.FaceColors&&G.multiply(E.color),!0===f.wireframe?ne(G,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):re(G)):(f instanceof THREE.MeshNormalMaterial?(ie.copy(E.normalModel).applyMatrix3(oe),G.setRGB(ie.x,ie.y,ie.z).multiplyScalar(.5).addScalar(.5)):G.setRGB(1,1,1),!0===f.wireframe?ne(G,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):re(G)))}X.union(Y)}}I.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}};