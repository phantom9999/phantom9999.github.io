THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var ie,oe,i,ae,se,le,ce,pe,Ee,ue,de,he=[],fe=0,me=[],r=0,t=[],n=0,o=[],a=0,ve=[],Re=0,xe={objects:[],lights:[],elements:[]},ye=new THREE.Vector3,Te=new THREE.Vector4,s=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),f=new THREE.Box3,m=new Array(3),He=(new Array(4),new THREE.Matrix4),we=new THREE.Matrix4,ge=new THREE.Matrix4,be=new THREE.Matrix3,Me=new THREE.Frustum,Se=new THREE.Vector4,ze=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var Ve=new function(){var l=[],c=[],p=null,E=null,u=new THREE.Matrix3;function n(e){var r=e.position,t=e.positionWorld,n=e.positionScreen;t.copy(r).applyMatrix4(de),n.copy(t).applyMatrix4(we);t=1/n.w;n.x*=t,n.y*=t,n.z*=t,e.visible=-1<=n.x&&n.x<=1&&-1<=n.y&&n.y<=1&&-1<=n.z&&n.z<=1}function d(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(m[0]=e.positionScreen,m[1]=r.positionScreen,m[2]=t.positionScreen,s.intersectsBox(f.setFromPoints(m)))}function h(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){E=(p=e).material,u.getNormalMatrix(p.matrixWorld),l.length=0,c.length=0},projectVertex:n,checkTriangleVisibility:d,checkBackfaceCulling:h,pushVertex:function(e,r,t){(i=je()).position.set(e,r,t),n(i)},pushNormal:function(e,r,t){l.push(e,r,t)},pushUv:function(e,r){c.push(e,r)},pushLine:function(e,r){e=me[e],r=me[r],(ce=Ce()).id=p.id,ce.v1.copy(e),ce.v2.copy(r),ce.z=(e.positionScreen.z+r.positionScreen.z)/2,ce.renderOrder=p.renderOrder,ce.material=p.material,xe.elements.push(ce)},pushTriangle:function(e,r,t){var n=me[e],i=me[r],o=me[t];if(!1!==d(n,i,o)&&(E.side===THREE.DoubleSide||!0===h(n,i,o))){(se=Oe()).id=p.id,se.v1.copy(n),se.v2.copy(i),se.v3.copy(o),se.z=(n.positionScreen.z+i.positionScreen.z+o.positionScreen.z)/3,se.renderOrder=p.renderOrder,se.normalModel.fromArray(l,3*e),se.normalModel.applyMatrix3(u).normalize();for(var a=0;a<3;a++){var s=se.vertexNormalsModel[a];s.fromArray(l,3*arguments[a]),s.applyMatrix3(u).normalize(),se.uvs[a].fromArray(c,2*arguments[a])}se.vertexNormalsLength=3,se.material=p.material,xe.elements.push(se)}}}};function je(){if(ae!==r)return me[ae++];var e=new THREE.RenderableVertex;return me.push(e),r++,ae++,e}function Oe(){if(le!==n)return t[le++];var e=new THREE.RenderableFace;return t.push(e),n++,le++,e}function Ce(){if(pe!==a)return o[pe++];var e=new THREE.RenderableLine;return o.push(e),a++,pe++,e}function Le(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}this.projectScene=function(e,r,t,n){function i(e){(ie=function(){if(oe!==fe)return he[oe++];var e=new THREE.RenderableObject;return he.push(e),fe++,oe++,e}()).id=e.id,ie.object=e,ye.setFromMatrixPosition(e.matrixWorld),ye.applyMatrix4(we),ie.z=ye.z,ie.renderOrder=e.renderOrder,xe.objects.push(ie)}ue=pe=le=0,!(xe.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),He.copy(r.matrixWorldInverse.getInverse(r.matrixWorld)),we.multiplyMatrices(r.projectionMatrix,He),Me.setFromMatrix(we),oe=0,xe.objects.length=0,xe.lights.length=0,e.traverseVisible(function(e){e instanceof THREE.Light?xe.lights.push(e):e instanceof THREE.Mesh||e instanceof THREE.Line?!1!==e.material.visible&&(!0===e.frustumCulled&&!1===Me.intersectsObject(e)||i(e)):e instanceof THREE.Sprite&&!1!==e.material.visible&&(!0===e.frustumCulled&&!1===Me.intersectsSprite(e)||i(e))}),!0===t&&xe.objects.sort(Le);for(var o,a,s,l,c,p,E,u,d=0,h=xe.objects.length;d<h;d++){var f,m=xe.objects[d].object,v=m.geometry;if(Ve.setObject(m),de=m.matrixWorld,ae=0,m instanceof THREE.Mesh){if(v instanceof THREE.BufferGeometry){var R=v.attributes,x=v.groups;if(void 0!==R.position){for(var y=0,T=(te=R.position.array).length;y<T;y+=3)Ve.pushVertex(te[y],te[y+1],te[y+2]);if(void 0!==R.normal)for(var H=R.normal.array,y=0,T=H.length;y<T;y+=3)Ve.pushNormal(H[y],H[y+1],H[y+2]);if(void 0!==R.uv)for(var w=R.uv.array,y=0,T=w.length;y<T;y+=2)Ve.pushUv(w[y],w[y+1]);if(null!==v.index){var g=v.index.array;if(0<x.length)for(var b=0;b<x.length;b++)for(var M=x[b],y=M.start,T=M.start+M.count;y<T;y+=3)Ve.pushTriangle(g[y],g[y+1],g[y+2]);else for(y=0,T=g.length;y<T;y+=3)Ve.pushTriangle(g[y],g[y+1],g[y+2])}else for(y=0,T=te.length/3;y<T;y+=3)Ve.pushTriangle(y,y+1,y+2)}}else if(v instanceof THREE.Geometry){var S=v.vertices,z=v.faces,V=v.faceVertexUvs[0];be.getNormalMatrix(de);for(var j=(I=m.material)instanceof THREE.MultiMaterial,O=!0==j?m.material:null,C=0,L=S.length;C<L;C++){var k=S[C];if(ye.copy(k),!0===I.morphTargets)for(var N=v.morphTargets,W=m.morphTargetInfluences,B=0,F=N.length;B<F;B++){var P,A=W[B];0!==A&&(P=N[B].vertices[C],ye.x+=(P.x-k.x)*A,ye.y+=(P.y-k.y)*A,ye.z+=(P.z-k.z)*A)}Ve.pushVertex(ye.x,ye.y,ye.z)}for(var D=0,G=z.length;D<G;D++){var I,U=z[D];if(void 0!==(I=!0==j?O.materials[U.materialIndex]:m.material)){var q=I.side,J=me[U.a],K=me[U.b],Q=me[U.c];if(!1!==Ve.checkTriangleVisibility(J,K,Q)){var X=Ve.checkBackfaceCulling(J,K,Q);if(q!==THREE.DoubleSide){if(q===THREE.FrontSide&&!1===X)continue;if(q===THREE.BackSide&&!0===X)continue}(se=Oe()).id=m.id,se.v1.copy(J),se.v2.copy(K),se.v3.copy(Q),se.normalModel.copy(U.normal),!1!==X||q!==THREE.BackSide&&q!==THREE.DoubleSide||se.normalModel.negate(),se.normalModel.applyMatrix3(be).normalize();for(var Y=U.vertexNormals,Z=0,$=Math.min(Y.length,3);Z<$;Z++){var _=se.vertexNormalsModel[Z];_.copy(Y[Z]),!1!==X||q!==THREE.BackSide&&q!==THREE.DoubleSide||_.negate(),_.applyMatrix3(be).normalize()}se.vertexNormalsLength=Y.length;var ee=V[D];if(void 0!==ee)for(var re=0;re<3;re++)se.uvs[re].copy(ee[re]);se.color=U.color,se.material=I,se.z=(J.positionScreen.z+K.positionScreen.z+Q.positionScreen.z)/3,se.renderOrder=m.renderOrder,xe.elements.push(se)}}}}}else if(m instanceof THREE.Line){if(v instanceof THREE.BufferGeometry){if(void 0!==(R=v.attributes).position){for(var te,y=0,T=(te=R.position.array).length;y<T;y+=3)Ve.pushVertex(te[y],te[y+1],te[y+2]);if(null!==v.index)for(y=0,T=(g=v.index.array).length;y<T;y+=2)Ve.pushLine(g[y],g[y+1]);else for(var ne=m instanceof THREE.LineSegments?2:1,y=0,T=te.length/3-1;y<T;y+=ne)Ve.pushLine(y,y+1)}}else if(v instanceof THREE.Geometry)if(ge.multiplyMatrices(we,de),0!==(S=m.geometry.vertices).length){(J=je()).positionScreen.copy(S[0]).applyMatrix4(ge);for(ne=m instanceof THREE.LineSegments?2:1,C=1,L=S.length;C<L;C++)(J=je()).positionScreen.copy(S[C]).applyMatrix4(ge),0<(C+1)%ne||(K=me[ae-2],Se.copy(J.positionScreen),ze.copy(K.positionScreen),!0==(a=ze,u=E=p=c=l=s=void 0,s=0,l=1,c=(o=Se).z+o.w,p=a.z+a.w,E=-o.z+o.w,u=-a.z+a.w,0<=c&&0<=p&&0<=E&&0<=u||!(c<0&&p<0||E<0&&u<0)&&(c<0?s=Math.max(s,c/(c-p)):p<0&&(l=Math.min(l,c/(c-p))),E<0?s=Math.max(s,E/(E-u)):u<0&&(l=Math.min(l,E/(E-u))),!(l<s)&&(o.lerp(a,s),a.lerp(o,1-l),!0)))&&(Se.multiplyScalar(1/Se.w),ze.multiplyScalar(1/ze.w),(ce=Ce()).id=m.id,ce.v1.positionScreen.copy(Se),ce.v2.positionScreen.copy(ze),ce.z=Math.max(Se.z,ze.z),ce.renderOrder=m.renderOrder,ce.material=m.material,m.material.vertexColors===THREE.VertexColors&&(ce.vertexColors[0].copy(m.geometry.colors[C]),ce.vertexColors[1].copy(m.geometry.colors[C-1])),xe.elements.push(ce)))}}else m instanceof THREE.Sprite&&(Te.set(de.elements[12],de.elements[13],de.elements[14],1),Te.applyMatrix4(we),f=1/Te.w,Te.z*=f,-1<=Te.z&&Te.z<=1&&((Ee=function(){if(ue!==Re)return ve[ue++];var e=new THREE.RenderableSprite;return ve.push(e),Re++,ue++,e}()).id=m.id,Ee.x=Te.x*f,Ee.y=Te.y*f,Ee.z=Te.z,Ee.renderOrder=m.renderOrder,Ee.object=m,Ee.rotation=m.rotation,Ee.scale.x=m.scale.x*Math.abs(Ee.x-(Te.x+r.projectionMatrix.elements[0])/(Te.w+r.projectionMatrix.elements[12])),Ee.scale.y=m.scale.y*Math.abs(Ee.y-(Te.y+r.projectionMatrix.elements[5])/(Te.w+r.projectionMatrix.elements[13])),Ee.material=m.material,xe.elements.push(Ee)))}return!0===n&&xe.elements.sort(Le),xe}};